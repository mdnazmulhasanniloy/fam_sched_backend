<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OTP Verified</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        :root {
        --primary: #765d56;
        --primary-light: #8c7068;
        --primary-bg: #f0e6e2;
        --success: #2a8a4b;
        --danger: #c83636;
        --text: #333;
        --text-light: #666;
        --border: #ddd;
        --shadow: 0 15px 35px rgba(118, 93, 86, 0.15);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        height: 100vh;
        width: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        background: linear-gradient(135deg, #f9f5f2 0%, #f0e6e2 100%);
      }

      .card {
        background: #fff;
        border-radius: 20px;
        padding: 50px 40px;
        text-align: center;
        max-width: 500px;
        width: 100%;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden; 
        border: 1px solid #e8d9d4;
      }
         .header-icon {
        width: 90px;
        height: 90px;
        margin: 0 auto 20px;
        background: var(--primary-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid var(--primary);
      }

      h1 {
        color: var(--primary);
        font-size: 28px;
        margin: 20px 0 10px;
      }

      .db-message {
        margin: 15px 0;
        display: flex;
        opacity: 1;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 5px 5px;
      }
      .db-message .icon {
        color: #c83636 !important;
      }
      .db-message p {
        color: #c83636 !important;
      }
      .form-group {
        margin-bottom: 20px;
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: start;
        justify-content: center;
        position: relative;
      }

      label {
        display: block;
        margin-bottom: 8px;
         color: var(--text);
        font-weight: 600;
        font-size: 15px;
      }

      input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 10px;
        font-size: 14px;
        outline: none;
         transition: all 0.3s;
        background: #fdfaf8;
      }

      input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(118, 93, 86, 0.15);
      }
      .show-button {
        position: absolute;
        right: 7px;
        top: 37px;
         color: #999;
        /* transition: all; */
        transition: color 0.3s;
        /* transition-duration: 0.5s; */
      }
      .show-button:hover {
        color: var(--primary);
        cursor: pointer;
      }

      .req-card {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 8px;
        background: #fff;
       border: 1px solid #e8d9d4;
       border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
       box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        font-size: 14px;  
        display: none;
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 10;
      }
      #newPassword:focus ~ .req-card {
        display: block;
      } 
      .req-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        color: #999;
      }
      .req-item.valid {
        color: var(--success);
      }
      .req-item .icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #f0e6e2;
        color: transparent;
        font-weight: bold;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .req-item.valid .icon {
        background: var(--success);
        color: white;
      }
       
     

      .small-hint {
        font-size: 13px;
        color: #888;
        margin-top: 6px;
      }

    

       .match {
        margin-top: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .match.ok {
       color: var(--success);
      }
      .match.bad {
      color: var(--danger); 
      }

      .match-bad-input {
        border: 1px solid var(--danger) !important;
      }
      /* button */
      .btn {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: white;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 10px;
        cursor: pointer;
         transition: all 0.3s;
        box-shadow: 0 6px 15px rgba(118, 93, 86, 0.3);
      }

      .btn:hover:not(:disabled) {
        background: var(--primary-light);
        transform: translateY(-3px); 
      }

      .btn:disabled {
         background: #b8a8a0;
         cursor: not-allowed;
        transform: none;
      }
 

      .note {
        font-size: 12px;
       color: #888;
        text-align: center;
        margin-top: 15px;
      }

      .circle {
        position: absolute;
        border-radius: 50%;
        background: rgba(118, 93, 86, 0.08);pointer-events: none;
       animation: float 8s ease-in-out infinite;
      }

      .circle.one { width: 120px; height: 120px; top: -40px; left: -40px; }
      .circle.two { width: 80px; height: 80px; bottom: -30px; right: -30px; animation-delay: 3s; } 

       .db-message {
        margin: 16px 0;
        padding: 12px;
        border-radius: 10px;
        font-size: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .db-message.error {
        background: #fdf2f2;
        color: var(--danger);
        border: 1px solid #fcd9d9;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) rotate(0deg);
        }
        50% {
          transform: translateY(-15px) rotate(45deg);
        }
      }

      /* Optional: responsive */
      @media (max-width: 500px) {
        .card {
          padding: 40px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="wraper">
        <div class="circle one"></div>
        <div class="circle two"></div>

        <div class="header-icon">
        <i data-lucide="lock" size="48" color="#765d56"></i>
      </div>
       <h1>Change Password</h1>
      <p class="subtitle">Create a strong new password for your account</p>
       <div id="db-message" class="db-message" style="display:none;"></div> 
        <form onsubmit="handleSubmit(event)">
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input
              type="password"
              id="newPassword"
              name="newPassword"
              required
            />
            <span
              class="show-button"
              onclick="togglePassword('newPassword', this)"
            >
              <i data-lucide="eye"></i>
            </span>
             <div class="req-card" id="reqCard">
            <div class="req-item" id="req-length"><span class="icon">✕</span> At least <strong>8 characters</strong></div>
            <div class="req-item" id="req-uppercase"><span class="icon">✕</span> One <strong>uppercase</strong> letter</div>
            <div class="req-item" id="req-number"><span class="icon">✕</span> At least <strong>1 number</strong></div>
            <div class="req-item" id="req-special"><span class="icon">✕</span> One <strong>special character</strong> (!@#$%^&*)</div>
          </div> 
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              required
            />
            <span
              class="show-button"
              onclick="togglePassword('confirmPassword', this)"
            >
              <i data-lucide="eye"></i>
            </span>

            <p id="passwordErrorC" style="color: red; font-size: 14px"></p>
            <p
              id="passwordErrorC"
              style="color: red; font-size: 13px; margin-top: 6px"
            ></p>
            <div id="matchIndicator" class="match"></div>
          </div>
          <button type="submit" disabled id="submitBtn" class="btn">
            Update Password
          </button>
          <p class="note">
            Make sure your new password is at least 8 characters long.
          </p>
        </form>
      </div>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const hasUpper = /[A-Z]/;
      const hasNumber = /\d/;
      const hasSpecial = /[!@#$%^&*]/;
      const minLen = v => v.length >= 8;

      const newPassword = document.getElementById('newPassword');
      const confirmPassword = document.getElementById('confirmPassword');
      const reqCard = document.getElementById('reqCard');
      const submitBtn = document.getElementById('submitBtn');
      const matchIndicator = document.getElementById('matchIndicator');

      const reqLength = document.getElementById('req-length');
      const reqUpper = document.getElementById('req-uppercase');
      const reqNumber = document.getElementById('req-number');
      const reqSpecial = document.getElementById('req-special');
      const div = document.getElementById('db-message');
      function setReqState(node, ok) {
        if (ok) {
          node.classList.add('valid');
          node.classList.remove('invalid');
          node.querySelector('.icon').textContent = '✓';
        } else {
          node.classList.add('invalid');
          node.classList.remove('valid');
          node.querySelector('.icon').textContent = '✖';
        }
      }
      function updateChecks() {
        const v = newPassword.value || '';
        const okLen = minLen(v);
        const okUpper = hasUpper.test(v);
        const okNum = hasNumber.test(v);
        const okSpecial = hasSpecial.test(v);

        setReqState(reqLength, okLen);
        setReqState(reqUpper, okUpper);
        setReqState(reqNumber, okNum);
        setReqState(reqSpecial, okSpecial);

        const allValid = okLen && okUpper && okNum && okSpecial;
        newPassword.style = allValid
          ? 'border-color: #367f55;'
          : 'border-color:#c83636;';
        const confirmVal = confirmPassword.value || '';
        const match = allValid && confirmVal && v === confirmVal;
        submitBtn.disabled = !match;

        updateMatchIndicator(v, confirmVal);
      }

      function updateMatchIndicator(pw, cpw) {
        console.log({ pw, cpw });
        if (!cpw) {
          matchIndicator.textContent = '';
          return;
        }
        if (pw === cpw) {
          // confirmPassword.style = 'border-color: #367f55;';
          matchIndicator.className = 'match ok';
          matchIndicator.textContent = 'Passwords match';
        } else {
          // confirmPassword.style = 'border-color:#c83636;';
          matchIndicator.className = 'match bad';
          matchIndicator.textContent = "Passwords don't match";
          submitBtn.disabled = true;
        }
      }

      newPassword.addEventListener('input', updateChecks);
      confirmPassword.addEventListener('input', updateChecks);

      function togglePassword(id, el) {
        const input = document.getElementById(id);
        if (input.type === 'password') {
          input.type = 'text';
          el.innerHTML = `<i data-lucide="eye-off"></i>`;
        } else {
          input.type = 'password';
          el.innerHTML = `<i data-lucide="eye"></i>`;
        }
        lucide.createIcons();
      }
      // change password functionc
      function responseError(message) {
        div.innerHTML = ` <i data-lucide="triangle-alert" class="icon"></i>
                        <p id="dbErrorMessage">${message}</p>`;
        lucide.createIcons();
      }

      async function handleSubmit(e) {
        e.preventDefault();

        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword =
          document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
          alert('Passwords do not match!');
          return;
        }

        try {
          const res = await fetch('/api/v1/auth/reset-password', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              authorization: `Bearer ${token}`,
              token: token,
            },
            body: JSON.stringify({
              newPassword: newPassword,
              confirmPassword: confirmPassword,
            }),
          });

          const data = await res.json();
          if (data?.success) {
            window.location.href = '/api/v1/auth/password-reset-success';
          }
          return responseError(data?.message || 'server error');
        } catch (error) {
          console.error('---------->>', error);
          responseError(error?.message || 'Error updating password!');
        }
      }
    </script>

    <!-- <i data-lucide="eye-off"></i> -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
      lucide.createIcons();
    </script>
  </body>
</html>
